<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DOSPad</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">

<style>
:root{
  --bg:#000;
  --fg:#00ff00;
  --border:#1d1d1d;
  --muted:#9aa;
  --mono: ui-monospace, Consolas, Menlo, monospace;
  --mark-bg: rgba(255,255,0,.25);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:#000;
  color:var(--fg);
  font-family:var(--mono);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* TOP */
.top{
  display:flex;gap:10px;flex-wrap:wrap;
  padding:10px;border-bottom:1px solid var(--border);
  background:#050505;
}
button,select,input[type="color"],input[type="text"]{
  font-family:var(--mono);
  background:#0a0a0a;
  border:1px solid var(--border);
  color:var(--fg);
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
}
button:active{transform:translateY(1px)}
.group{display:flex;gap:6px;align-items:center;border:1px solid var(--border);padding:6px;border-radius:12px}
.pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:4px 8px;border-radius:999px}
.spacer{flex:1}

/* TABS */
.tabs{
  display:flex;gap:6px;padding:8px;
  border-bottom:1px solid var(--border);
  background:#030303;overflow:auto;
}
.tab{
  padding:6px 10px;border:1px solid var(--border);
  border-radius:10px;background:#070707;
  cursor:pointer;display:flex;gap:6px;align-items:center;
}
.tab.active{border-color:var(--fg)}
.tab button{padding:2px 6px;font-size:12px}

/* EDITOR */
.wrap{flex:1;display:flex;flex-direction:column;min-height:0}
.editorShell{
  position:relative;flex:1;min-height:0;
}

/* OVERLAY FIXED */
.highlights,textarea{
  position:absolute;inset:0;
  padding:14px;
  font-family:var(--mono);
  font-size:15px;
  line-height:1.5;
  white-space:pre-wrap;
  word-wrap:break-word;
  tab-size:2;
}

.highlights{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  pointer-events:none;
  overflow:hidden;
  font-variant-ligatures:none;
  font-kerning:none;
}

textarea{
  background:transparent;
  color:transparent;
  -webkit-text-fill-color:transparent;
  caret-color:var(--fg);
  border:0;
  outline:0;
  resize:none;
  overflow:auto;
  font-variant-ligatures:none;
  font-kerning:none;
}

mark{
  background:var(--mark-bg);
  color:inherit;
  border-radius:4px;
  padding:0 1px;
}

/* STATUS */
.status{
  padding:6px 10px;
  border-top:1px solid var(--border);
  font-size:12px;
  color:var(--muted);
  display:flex;gap:12px;
}
</style>
</head>

<body>

<div class="top">
  <button id="newBtn">New</button>
  <button id="openBtn">Open</button>
  <button id="saveBtn">Save</button>

  <div class="group">
    <span class="pill">Find</span>
    <input id="findInput" type="text" placeholder="Buscar... (Enter siguiente)">
  </div>

  <div class="spacer"></div>
  <span class="pill">Autosave ON</span>
  <input id="fileIn" type="file" hidden>
  <a id="dl" hidden></a>
</div>

<div class="tabs" id="tabs"></div>

<div class="wrap">
  <div class="editorShell">
    <pre class="highlights" id="highlights"></pre>
    <textarea id="ed"></textarea>
  </div>

  <div class="status">
    <span id="meta">Ln 1, Col 1 · 0 chars</span>
  </div>
</div>

<script>
(() => {

const ed = document.getElementById("ed");
const highlights = document.getElementById("highlights");
const tabsEl = document.getElementById("tabs");
const fileIn = document.getElementById("fileIn");
const dl = document.getElementById("dl");
const findInput = document.getElementById("findInput");
const meta = document.getElementById("meta");

const KEY = "dospad.docs.v3";

let state = {
  docs: [],
  active: null,
  find: ""
};

function uid(){ return Math.random().toString(16).slice(2); }

function saveAll(){
  localStorage.setItem(KEY, JSON.stringify(state));
}

function loadAll(){
  const raw = localStorage.getItem(KEY);
  if(raw){
    state = JSON.parse(raw);
  } else {
    const d = {id:uid(), name:"Untitled.txt", text:""};
    state.docs=[d];
    state.active=d.id;
  }
}

function getActive(){
  return state.docs.find(d=>d.id===state.active);
}

function renderTabs(){
  tabsEl.innerHTML="";
  for(const d of state.docs){
    const t=document.createElement("div");
    t.className="tab"+(d.id===state.active?" active":"");
    t.textContent=d.name;
    t.onclick=()=>switchTab(d.id);

    const close=document.createElement("button");
    close.textContent="×";
    close.onclick=(e)=>{e.stopPropagation();closeTab(d.id);};
    t.appendChild(close);
    tabsEl.appendChild(t);
  }
  const add=document.createElement("button");
  add.textContent="+";
  add.onclick=newTab;
  tabsEl.appendChild(add);
}

function switchTab(id){
  const cur=getActive();
  if(cur) cur.text=ed.value;
  state.active=id;
  const d=getActive();
  ed.value=d.text;
  renderTabs();
  renderHighlights();
  updateMeta();
  saveAll();
}

function newTab(){
  const d={id:uid(),name:"Untitled.txt",text:""};
  state.docs.push(d);
  state.active=d.id;
  renderTabs();
  switchTab(d.id);
}

function closeTab(id){
  state.docs=state.docs.filter(d=>d.id!==id);
  if(state.active===id) state.active=state.docs[0].id;
  renderTabs();
  switchTab(state.active);
}

function renderHighlights(){
  const text=ed.value;
  const q=state.find;
  if(!q){
    highlights.textContent=text;
    return;
  }
  const esc=q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
  const re=new RegExp(esc,"gi");
  highlights.innerHTML=text.replace(re,m=>"<mark>"+m+"</mark>");
}

function updateMeta(){
  const t=ed.value;
  const i=ed.selectionStart||0;
  const before=t.slice(0,i);
  const line=before.split("\n").length;
  const col=i-before.lastIndexOf("\n");
  meta.textContent=`Ln ${line}, Col ${col} · ${t.length} chars`;
}

function syncScroll(){
  highlights.scrollTop=ed.scrollTop;
  highlights.scrollLeft=ed.scrollLeft;
}

ed.addEventListener("input",()=>{
  getActive().text=ed.value;
  renderHighlights();
  updateMeta();
  saveAll();
});

ed.addEventListener("scroll",syncScroll);
ed.addEventListener("click",updateMeta);
ed.addEventListener("keyup",updateMeta);

findInput.addEventListener("input",()=>{
  state.find=findInput.value;
  renderHighlights();
});

document.getElementById("newBtn").onclick=newTab;
document.getElementById("openBtn").onclick=()=>fileIn.click();
document.getElementById("saveBtn").onclick=()=>{
  const blob=new Blob([ed.value],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  dl.href=url;
  dl.download=getActive().name;
  dl.click();
};

fileIn.onchange=async()=>{
  const f=fileIn.files[0];
  if(!f)return;
  const text=await f.text();
  const d={id:uid(),name:f.name,text};
  state.docs.push(d);
  state.active=d.id;
  renderTabs();
  switchTab(d.id);
};

loadAll();
renderTabs();
switchTab(state.active);
})();
</script>

</body>
</html>
